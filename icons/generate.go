//go:build ignore

package main

import (
	"bytes"
	"fmt"
	"os"
	"path/filepath"
	"strings"
	"text/template"

	"github.com/invopop/gobl/pkg/here"

	"golang.org/x/text/cases"
	"golang.org/x/text/language"
)

const (
	themeDefault   = "default"
	baseThemesPath = "../../popui/icons/themes" // Assume main popui repo is available
)

func main() {
	if error := generate(); error != nil {
		panic(error)
	}
}

// generate will prepare an icons templ file that contains all of the icons provided
// by popui.
func generate() error {
	tt := here.Doc(`
		// Code generated by popui - DO NOT EDIT.

		package icons

		//lint:file-ignore SA4006 This context is only used if a nested component is present.

		{{ range .Icons }}
		templ {{ .Name }}() {
			<div style="width: 16px; height: 16px;">
				{{ .Data }}
			</div>
		}
		{{ end }}
	`)
	tmpl, err := template.New("base").Parse(tt)
	if err != nil {
		return fmt.Errorf("preparing template: %w", err)
	}

	files, err := os.ReadDir(filepath.Join(baseThemesPath, themeDefault))
	if err != nil {
		return fmt.Errorf("loading directory: %w", err)
	}

	type Icon struct {
		Name string
		Data string
	}

	caser := cases.Title(language.English)

	icons := []Icon{}
	for _, file := range files {
		if file.IsDir() {
			continue
		}

		// Remove the .svg extension.
		filename := file.Name()[:len(file.Name())-4]
		// Convert to camel case from dashed case
		name := caser.String(strings.ReplaceAll(filename, "-", " "))
		name = strings.ReplaceAll(name, " ", "")
		icon := Icon{
			Name: name,
		}

		data, err := os.ReadFile(filepath.Join(baseThemesPath, themeDefault, file.Name()))
		if err != nil {
			return fmt.Errorf("reading icon file %v: %w", file.Name(), err)
		}
		// Remove new lines for embedding, this should be safe as SVG ignores whitespace.
		icon.Data = strings.ReplaceAll(string(data), "\n", "")
		icons = append(icons, icon)
	}

	out := bytes.NewBuffer(nil)
	tmpl.Execute(out, map[string]any{"Icons": icons})

	f := filepath.Join("icons_list.templ")
	if err := os.WriteFile(f, out.Bytes(), 0644); err != nil {
		return err
	}
	fmt.Printf("Processed %v\n", f)

	return nil
}
